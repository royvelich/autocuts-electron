<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/render-status.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<dom-module id="mesh-canvas">
  <template>
    <style>
      :host {
        width: 100%;
        height: 100%;
      }

      canvas {
        display: block;
      }

      .container {
        overflow: hidden;
        width: 100%;
        height: 100%;
        position: relative;
      }

      .canvas-title {
        margin: 0px;
        padding: 0px;
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 30px;
        color: white;
      }      
    </style>
    <div class="container">
      <div class="canvas-title">
        [[title]]
      </div>
    </div>
  </template>
  <script>
    class MeshCanvas extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior], Polymer.Element) {
      static get is() { 
        return "mesh-canvas";
      }

      static get properties() {
        return {
          data: {
            type: Object,
            value: function() {
              return {};
            },
            observer: 'dataChanged'
          },
          title: {
            type: String
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();
        this.addEventListener('iron-resize', e => this._resizeScene());
        Polymer.RenderStatus.beforeNextRender(this, function() {
          this._createScene();
          this._resizeScene()
          this._connectScene();
          this._renderScene();
        });
      }

      ready() {
        super.ready();
      }

      dataChanged(newValue, oldValue) {
        //console.log('changed');
      }

      _createScene() {
        let THREE = require('three');

        this.camera = new THREE.PerspectiveCamera(75, 0, 1, 10000);
        this.camera.position.z = 1000;

        let geometry = new THREE.BoxGeometry(700, 700, 700, 10, 10, 10);
        let material = new THREE.MeshBasicMaterial({color: 0xfffff, wireframe: true});
        let cube = new THREE.Mesh(geometry, material);

        this.scene = new THREE.Scene();
        this.scene.add(cube);

        this.renderer = new THREE.WebGLRenderer({
          antialias: true
        });

        this.renderer.setPixelRatio(window.devicePixelRatio);

        let OrbitControls = require('three-orbit-controls')(THREE);
        this.controls = new OrbitControls(this.camera, this.renderer.domElement);
				this.controls.enableDamping = true;
				this.controls.dampingFactor = 0.25;
				this.controls.screenSpacePanning = false;
				this.controls.minDistance = 100;
				this.controls.maxDistance = 2000;
				this.controls.maxPolarAngle = Math.PI / 2;
      }

      _resizeScene() {
        let THREE = require('three');
        this.camera.aspect = this.offsetWidth / (this.offsetHeight);
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(this.offsetWidth, this.offsetHeight);
      }

      _renderScene() {
        requestAnimationFrame(() => this._renderScene());
        this.renderer.render(this.scene, this.camera);
      }

      _connectScene() {
        this.root.querySelector('.container').appendChild(this.renderer.domElement);
      }
    }
    customElements.define(MeshCanvas.is, MeshCanvas);
  </script>
</dom-module>